<!-- Chatbot Component -->
<div id="chatbot-container" class="fixed bottom-4 right-4 sm:bottom-6 sm:right-6 z-50">
    <!-- Chat Window -->
    <div id="chatbot-window" class="hidden w-[calc(100vw-2rem)] sm:w-96 max-w-sm h-[calc(100vh-8rem)] sm:h-[600px] max-h-[600px] bg-slate-900 border border-slate-700 rounded-2xl shadow-2xl flex flex-col backdrop-blur-xl bg-opacity-95">
        <!-- Header -->
        <div class="bg-gradient-to-r from-slate-800 to-slate-900 border-b border-slate-700 px-4 sm:px-6 py-3 sm:py-4 rounded-t-2xl flex items-center justify-between flex-shrink-0">
            <div class="flex items-center gap-2 sm:gap-3 min-w-0">
                <div class="w-8 h-8 sm:w-10 sm:h-10 rounded-full bg-gradient-to-br from-primary/30 to-primary/50 border-2 border-primary/40 flex items-center justify-center flex-shrink-0">
                    <svg class="w-4 h-4 sm:w-6 sm:h-6 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path>
                    </svg>
                </div>
                <div class="min-w-0">
                    <h3 class="text-white font-bold text-xs sm:text-sm truncate">Larry</h3>
                    <p class="text-slate-400 text-xs truncate">ApexCore Support</p>
                </div>
            </div>
            <button id="close-chatbot" class="text-slate-400 hover:text-white transition-colors flex-shrink-0 ml-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        
        <!-- Messages Area -->
        <div id="chatbot-messages" class="flex-1 overflow-y-auto p-3 sm:p-6 space-y-3 sm:space-y-4 min-h-0">
            <!-- Welcome Message -->
            <div class="flex items-start gap-2 sm:gap-3">
                <div class="w-7 h-7 sm:w-8 sm:h-8 rounded-full bg-gradient-to-br from-primary/30 to-primary/50 border border-primary/40 flex items-center justify-center flex-shrink-0">
                    <span class="text-primary text-xs font-bold">L</span>
                </div>
                <div class="flex-1 min-w-0">
                    <div class="bg-slate-800/80 border border-slate-700 rounded-2xl rounded-tl-sm px-3 py-2 sm:px-4 sm:py-3">
                        <p class="text-slate-200 text-xs sm:text-sm break-words">Hi! I'm Larry, your ApexCore support agent. How can I help you today? I can answer questions about our payment processing services, high-risk accounts, or help you get started.</p>
                    </div>
                    <span class="text-xs text-slate-500 mt-1 block">Just now</span>
                </div>
            </div>
        </div>
        
        <!-- Input Area -->
        <div class="border-t border-slate-700 p-3 sm:p-4 bg-slate-800/50 flex-shrink-0">
            <form id="chatbot-form" class="flex items-center gap-2 sm:gap-3">
                <input 
                    type="text" 
                    id="chatbot-input" 
                    placeholder="Type your message..." 
                    class="flex-1 px-3 py-2 sm:px-4 sm:py-3 rounded-xl bg-slate-700/50 border border-slate-600 text-white placeholder-slate-500 focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all text-xs sm:text-sm min-w-0"
                    autocomplete="off"
                >
                <button 
                    type="submit" 
                    class="w-9 h-9 sm:w-11 sm:h-11 rounded-xl bg-primary hover:bg-primary-dark text-white flex items-center justify-center transition-all duration-300 transform hover:scale-105 shadow-lg shadow-primary/20 flex-shrink-0"
                >
                    <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                    </svg>
                </button>
            </form>
        </div>
    </div>
    
    <!-- Chat Icon Button -->
    <button 
        id="chatbot-toggle" 
        class="w-12 h-12 sm:w-14 sm:h-14 rounded-full bg-primary hover:bg-primary-dark text-white shadow-2xl shadow-primary/30 flex items-center justify-center transition-all duration-300 transform hover:scale-110"
    >
        <svg id="chat-icon" class="w-5 h-5 sm:w-6 sm:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path>
        </svg>
    </button>
</div>

<script>
    // Predefined responses from Larry
    const larryResponses = [
        "Great question! At ApexCore, we specialize in high-risk payment processing. We can help you get approved for a merchant account in as little as 24 hours, even if traditional banks have rejected you.",
        "We support 135+ currencies and offer both domestic and offshore merchant accounts. Our approval rate is 99%, and we work with industries like CBD, forex, adult entertainment, and more.",
        "Our chargeback protection tool is one of our most popular features. It uses AI to detect and prevent fraudulent transactions before they happen, saving merchants an average of 15% in revenue.",
        "Yes, we offer instant approvals! Our AI-driven underwriting process can get you pre-approved within 24 hours. No more waiting weeks for an answer from traditional banks.",
        "We have no monthly processing limits, which makes us perfect for high-growth businesses. You can scale without worrying about hitting caps or having your account frozen.",
        "Our setup process is simple: 1) Fill out our 5-minute application, 2) Upload your documents, 3) We negotiate with the banks, 4) Integrate our API and start processing. Most clients are up and running within 48 hours.",
        "We're verified partners with 15+ Tier-1 banks worldwide. This gives us access to better rates and more flexible terms than you'd get going directly to a bank.",
        "Our fees are transparent - no setup fees, no hidden costs. We make money when you make money, so our success is tied to yours. Contact our sales team for a custom quote based on your volume.",
        "We support all major payment methods: credit cards, debit cards, ACH, e-checks, and even crypto in some cases. Our payment gateway integrates seamlessly with Shopify, WooCommerce, and custom solutions.",
        "Absolutely! We specialize in helping businesses that have been shut down by other processors. We understand high-risk industries and work with banks that are comfortable with your business model.",
        "Our global settlement options allow you to accept payments in multiple currencies and settle in your local bank account. This is perfect for international businesses.",
        "Security is our top priority. We're PCI DSS Level 1 compliant and use bank-level encryption for all transactions. Your customers' data is always protected.",
        "We offer 24/7 support to all our clients. Whether you need technical help with integration or have questions about your account, our team is always available.",
        "Our partner program offers generous residuals for ISOs and referral agents. If you're interested in becoming a partner, I can connect you with our partnership team.",
        "We process millions in transactions monthly for businesses across various high-risk industries. Our platform is built to handle high volume and scale with your growth."
    ];

    // Get DOM elements
    const chatbotToggle = document.getElementById('chatbot-toggle');
    const chatbotWindow = document.getElementById('chatbot-window');
    const closeChatbot = document.getElementById('close-chatbot');
    const chatbotForm = document.getElementById('chatbot-form');
    const chatbotInput = document.getElementById('chatbot-input');
    const chatbotMessages = document.getElementById('chatbot-messages');

    // Toggle chatbot window
    function toggleChatbot() {
        chatbotWindow.classList.toggle('hidden');
        
        if (!chatbotWindow.classList.contains('hidden')) {
            // Hide the toggle button when window is open
            chatbotToggle.classList.add('hidden');
            chatbotInput.focus();
            // Scroll to bottom
            setTimeout(() => {
                chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
            }, 100);
        } else {
            // Show the toggle button when window is closed
            chatbotToggle.classList.remove('hidden');
        }
    }

    // Close chatbot
    function closeChatbotWindow() {
        chatbotWindow.classList.add('hidden');
        // Show the toggle button when window is closed
        chatbotToggle.classList.remove('hidden');
    }

    // Add message to chat
    function addMessage(text, isUser = false) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `flex items-start gap-3 ${isUser ? 'flex-row-reverse' : ''}`;
        
        if (isUser) {
            messageDiv.innerHTML = `
                <div class="w-7 h-7 sm:w-8 sm:h-8 rounded-full bg-slate-700 flex items-center justify-center flex-shrink-0">
                    <svg class="w-3 h-3 sm:w-4 sm:h-4 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                </div>
                <div class="flex-1 max-w-[80%] min-w-0">
                    <div class="bg-primary/20 border border-primary/30 rounded-2xl rounded-tr-sm px-3 py-2 sm:px-4 sm:py-3">
                        <p class="text-slate-200 text-xs sm:text-sm break-words">${text}</p>
                    </div>
                    <span class="text-xs text-slate-500 mt-1 block text-right">Just now</span>
                </div>
            `;
        } else {
            messageDiv.innerHTML = `
                <div class="w-7 h-7 sm:w-8 sm:h-8 rounded-full bg-gradient-to-br from-primary/30 to-primary/50 border border-primary/40 flex items-center justify-center flex-shrink-0">
                    <span class="text-primary text-xs font-bold">L</span>
                </div>
                <div class="flex-1 max-w-[80%] min-w-0">
                    <div class="bg-slate-800/80 border border-slate-700 rounded-2xl rounded-tl-sm px-3 py-2 sm:px-4 sm:py-3">
                        <p class="text-slate-200 text-xs sm:text-sm break-words">${text}</p>
                    </div>
                    <span class="text-xs text-slate-500 mt-1 block">Larry â€¢ Just now</span>
                </div>
            `;
        }
        
        chatbotMessages.appendChild(messageDiv);
        
        // Scroll to bottom
        setTimeout(() => {
            chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
        }, 100);
    }

    // Get random response
    function getRandomResponse() {
        return larryResponses[Math.floor(Math.random() * larryResponses.length)];
    }

    // Handle form submission
    chatbotForm.addEventListener('submit', (e) => {
        e.preventDefault();
        
        const userMessage = chatbotInput.value.trim();
        if (!userMessage) return;
        
        // Add user message
        addMessage(userMessage, true);
        
        // Clear input
        chatbotInput.value = '';
        
        // Show typing indicator
        const typingDiv = document.createElement('div');
        typingDiv.className = 'flex items-start gap-3';
        typingDiv.id = 'typing-indicator';
        typingDiv.innerHTML = `
            <div class="w-7 h-7 sm:w-8 sm:h-8 rounded-full bg-gradient-to-br from-primary/30 to-primary/50 border border-primary/40 flex items-center justify-center flex-shrink-0">
                <span class="text-primary text-xs font-bold">L</span>
            </div>
            <div class="flex-1 min-w-0">
                <div class="bg-slate-800/80 border border-slate-700 rounded-2xl rounded-tl-sm px-3 py-2 sm:px-4 sm:py-3">
                    <div class="flex gap-1">
                        <div class="w-2 h-2 bg-slate-400 rounded-full animate-bounce" style="animation-delay: 0s;"></div>
                        <div class="w-2 h-2 bg-slate-400 rounded-full animate-bounce" style="animation-delay: 0.2s;"></div>
                        <div class="w-2 h-2 bg-slate-400 rounded-full animate-bounce" style="animation-delay: 0.4s;"></div>
                    </div>
                </div>
            </div>
        `;
        chatbotMessages.appendChild(typingDiv);
        chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
        
        // Call the chatbot API
        fetch('/chatbot', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ user_input: userMessage })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            // Remove typing indicator
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
            // Add the response message
            addMessage(data.response || 'I\'m sorry, I couldn\'t process that request. Please try again.');
        })
        .catch(error => {
            console.error('Error calling chatbot API:', error);
            // Remove typing indicator
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
            // Show error message
            addMessage('I\'m sorry, I\'m having trouble connecting right now. Please try again later or contact our support team.');
        });
    });

    // Event listeners
    chatbotToggle.addEventListener('click', toggleChatbot);
    closeChatbot.addEventListener('click', closeChatbotWindow);

    // Close on escape key
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && !chatbotWindow.classList.contains('hidden')) {
            closeChatbotWindow();
        }
    });
</script>

<style>
    /* Custom scrollbar for chat messages */
    #chatbot-messages::-webkit-scrollbar {
        width: 6px;
    }
    
    #chatbot-messages::-webkit-scrollbar-track {
        background: rgba(15, 23, 42, 0.5);
        border-radius: 3px;
    }
    
    #chatbot-messages::-webkit-scrollbar-thumb {
        background: rgba(14, 165, 233, 0.5);
        border-radius: 3px;
    }
    
    #chatbot-messages::-webkit-scrollbar-thumb:hover {
        background: rgba(14, 165, 233, 0.7);
    }
    
    /* Smooth animations */
    #chatbot-window {
        animation: slideUp 0.3s ease-out;
    }
    
    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    /* Mobile-specific adjustments */
    @media (max-width: 640px) {
        #chatbot-container {
            bottom: 1rem;
            right: 1rem;
            left: 1rem;
        }
        
        #chatbot-window {
            width: 100% !important;
            max-width: 100% !important;
            height: calc(100vh - 8rem) !important;
            max-height: calc(100vh - 8rem) !important;
        }
        
        #chatbot-toggle {
            position: absolute;
            bottom: 0;
            right: 0;
        }
    }
    
    /* Ensure proper scrolling on mobile */
    #chatbot-messages {
        -webkit-overflow-scrolling: touch;
    }
    
    /* Prevent text selection issues on mobile */
    #chatbot-input {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
    }
</style>
